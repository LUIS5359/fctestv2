<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Generar Factura — Tema Oscuro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220;        /* fondo principal */
      --panel:#111827;     /* tarjetas/paneles */
      --muted:#94a3b8;     /* texto secundario */
      --text:#e5e7eb;      /* texto principal */
      --accent:#22d3ee;    /* acento (teal) */
      --accent-2:#60a5fa;  /* acento secundario (azul) */
      --border:#1f2937;    /* bordes */
      --success:#10b981;   /* éxito */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 800px at 10% -10%, #16213a 0%, var(--bg) 45%),
                        radial-gradient(1000px 600px at 120% 0%, #0f172a 0%, transparent 50%) , var(--bg);
      color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      line-height:1.45;
    }
    .container{max-width:880px; margin:40px auto; padding:0 16px;}
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px;
    }
    .title{font-size:1.25rem; font-weight:700; letter-spacing:.3px}
    .badge{
      font-size:.8rem; padding:6px 10px; border-radius:999px; background:rgba(34,211,238,.1); color:var(--accent);
      border:1px solid rgba(34,211,238,.25);
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border:1px solid var(--border); border-radius:14px; padding:18px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
      backdrop-filter:saturate(120%) blur(6px);
    }
    label{display:block; font-weight:600; margin-bottom:8px; color:#cbd5e1}
    input[type="text"], input[type="date"], input[type="number"], select, textarea{
      width:100%;
      color:var(--text);
      background:#0b1324;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 14px;
      font-family:inherit;
      font-size:1rem;
      outline:none;
    }
    textarea{
      min-height:160px;
      border-radius:12px; padding:12px 14px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      resize:vertical; outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color:#334155; box-shadow:0 0 0 3px rgba(96,165,250,.15)}
    .row{display:flex; gap:12px; flex-wrap:wrap; margin-top:14px}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:14px;
      margin-bottom:18px;
    }
    .field{margin-bottom:16px}
    .hidden{display:none}
    .btn{
      appearance:none; border:1px solid var(--border); background:#0b1324; color:var(--text);
      padding:12px 16px; border-radius:12px; font-weight:700; letter-spacing:.2px; cursor:pointer;
      transition: transform .04s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .btn:hover{border-color:#334155; box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .btn:active{transform:translateY(1px)}
    .btn.local1{background: linear-gradient(180deg, rgba(34,211,238,.15), rgba(34,211,238,.05)); border-color: rgba(34,211,238,.35)}
    .btn.local2{background: linear-gradient(180deg, rgba(96,165,250,.15), rgba(96,165,250,.05)); border-color: rgba(96,165,250,.35)}
    .hint{color:var(--muted); font-size:.95rem; margin-top:8px}
    .examples{margin-top:18px; display:grid; grid-template-columns:1fr; gap:14px}
    .example{
      border:1px dashed #243244; border-radius:12px; padding:14px; background:#0b1324;
    }
    .example h3{margin:0 0 8px 0; font-size:1rem; color:#cbd5e1}
    code.block{
      display:block; background:#0b1324; border:1px solid var(--border);
      border-radius:10px; padding:10px 12px; color:#d1d5db; white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    .footer{margin-top:22px; display:flex; gap:10px; align-items:center; color:#9ca3af; font-size:.9rem}
    .dot{width:8px; height:8px; border-radius:50%; background:var(--success); box-shadow:0 0 10px rgba(16,185,129,.8)}
    .rules{margin-top:18px; padding:14px; border:1px solid #1f2937; border-radius:12px; background:rgba(15,23,42,.6);}
    .rules h3{margin:0 0 10px 0; font-size:1rem; color:#cbd5e1}
    .rules ul{margin:0; padding-left:20px; color:#cbd5e1}
    .rules li{margin-bottom:6px}
    .errors{display:none; margin-top:12px; border-radius:12px; border:1px solid rgba(244,63,94,.4); background:rgba(244,63,94,.1); padding:12px; color:#fecdd3; font-size:.95rem}
    .errors ul{margin:0; padding-left:20px}
    .preview{margin-top:18px; border:1px solid var(--border); border-radius:12px; padding:16px; background:rgba(15,23,42,.6)}
    .preview-header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px}
    .preview-header h3{margin:0; font-size:1rem; color:#cbd5e1}
    .preview-total{font-weight:700; color:var(--accent-2)}
    .preview-list{display:flex; flex-direction:column; gap:10px}
    .preview-item{display:flex; justify-content:space-between; gap:12px; border-bottom:1px solid rgba(148,163,184,.2); padding-bottom:10px}
    .preview-item:last-child{border-bottom:none; padding-bottom:0}
    .preview-desc{flex:1; display:flex; gap:8px; align-items:center}
    .preview-qty{font-weight:700; color:var(--accent)}
    .preview-prices{text-align:right; min-width:130px}
    .preview-prices div{line-height:1.2}
    .preview-empty-text{margin:0; color:var(--muted)}
    .preview-errors{margin-top:12px; font-size:.9rem; color:#fecaca}

    @media (max-width: 640px){
      .container{margin:24px auto; padding:0 12px;}
      .header{flex-direction:column; align-items:flex-start;}
      .title{font-size:1.1rem;}
      .row{flex-direction:column;}
      .btn{width:100%; text-align:center;}
      .preview-header{flex-direction:column; align-items:flex-start; gap:6px;}
      .preview-item{flex-direction:column; align-items:flex-start;}
      .preview-prices{text-align:left; min-width:auto;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">Generar Factura</div>
      <span class="badge">Tema oscuro</span>
    </div>

    <div class="card">
      <form action="/generar_desde_texto" method="POST" target="_blank" id="facturaForm">
        <div class="grid">
          <div class="field">
            <label for="cliente">Cliente</label>
            <input type="text" id="cliente" name="cliente" placeholder="Ana Pérez" />
          </div>
          <div class="field">
            <label for="fecha">Fecha</label>
            <input type="date" id="fecha" name="fecha" />
          </div>
        </div>

        <div class="grid">
          <div class="field">
            <label for="estado">Estado</label>
            <select id="estado" name="estado">
              <option value="">Selecciona una opción</option>
              <option value="PAGADO">Pagado</option>
              <option value="PENDIENTE">Pendiente</option>
              <option value="PAGO PARCIAL">Pago parcial</option>
              <option value="ENVIADO">Enviado</option>
              <option value="RECIBIDO">Recibido</option>
            </select>
          </div>
          <div class="field hidden" id="pagoParcialField">
            <label for="montoParcial">Monto pago parcial</label>
            <input type="number" step="0.01" min="0" id="montoParcial" name="monto_parcial" placeholder="0.00" />
          </div>
        </div>

        <div class="field">
          <label for="productos">Productos</label>
          <textarea id="productos" name="productos" spellcheck="false" placeholder="3 pelota gloria a 65&#10;2 calcetines negros a 25"></textarea>
        </div>

        <div class="preview" id="previewContainer">
          <div class="preview-header">
            <h3>Vista previa y totales</h3>
            <span class="preview-total" id="previewTotal">Total: Q0.00</span>
          </div>
          <div id="previewList" class="preview-list">
            <p class="preview-empty-text">Agrega productos con el formato "3 pelota gloria a 65" para ver el desglose.</p>
          </div>
          <div id="previewErrors" class="preview-errors hidden"></div>
        </div>

        <!-- Campo oculto que decidirá Local 1 (A) o Local 2 (B) -->
        <input type="hidden" name="plantilla" id="plantilla" value="A" />

        <div class="errors" id="errores"></div>

        <div class="row">
          <button type="button" class="btn local1" onclick="iniciarDescarga(event,'A')">Local 1</button>
          <button type="button" class="btn local2" onclick="iniciarDescarga(event,'B')">Local 2</button>
        </div>

        <p class="hint">Se descargarán dos archivos separados (PDF y la imagen tipo captura). Completa los campos, revisa la vista previa y selecciona el local para continuar.</p>

        <div class="examples">
          <div class="example">
            <h3>Ejemplo de formato con productos (solo referencia)</h3>
            <code class="block">3 pelota gloria a 65
2 camisetas básicas a 90
1 mochila urbana por Q250</code>
          </div>
        </div>

        <div class="footer">
          <span class="dot"></span>
          <span>Listo para generar: completa tus datos y selecciona el local.</span>
        </div>
      </form>
    </div>
  </div>

<script>
  const form = document.getElementById('facturaForm');
  const erroresBox = document.getElementById('errores');
  const fechaInput = document.getElementById('fecha');
  const estadoSelect = document.getElementById('estado');
  const pagoParcialField = document.getElementById('pagoParcialField');
  const pagoParcialInput = document.getElementById('montoParcial');
  const productosTextarea = document.getElementById('productos');
  const previewList = document.getElementById('previewList');
  const previewTotal = document.getElementById('previewTotal');
  const previewErrors = document.getElementById('previewErrors');
  const currencyFormatter = new Intl.NumberFormat('es-GT', { style: 'currency', currency: 'GTQ' });

  fechaInput.valueAsDate = new Date();

  estadoSelect.addEventListener('change', () => {
    const show = estadoSelect.value === 'PAGO PARCIAL';
    pagoParcialField.classList.toggle('hidden', !show);
    if (!show) {
      pagoParcialInput.value = '';
    }
  });

  productosTextarea.addEventListener('input', actualizarPreview);
  actualizarPreview();

  form.addEventListener('submit', function(evt){
    evt.preventDefault();
    validarFormulario();
  });

  function validarFormulario(){
    const cliente = (document.getElementById('cliente').value || '').trim();
    const fecha = fechaInput.value;
    const estado = estadoSelect.value;
    const productosTexto = (productosTextarea.value || '').trim();
    const pagoParcial = pagoParcialInput.value;
    const errores = [];
    let lineasProductos = [];

    if (!cliente) {
      errores.push('Agrega el nombre del cliente.');
    }
    if (!fecha) {
      errores.push('Selecciona una fecha.');
    }
    if (!estado) {
      errores.push('Selecciona un estado para el pedido.');
    }
    if (!productosTexto) {
      errores.push('Agrega al menos un producto.');
    } else {
      lineasProductos = productosTexto.split('\n').map(linea => linea.trim()).filter(Boolean);
      const lineaInvalida = lineasProductos.find(linea => !parseLineaProducto(linea));
      if (lineaInvalida) {
        errores.push('Sigue el formato "3 pelota gloria a 65" en cada línea.');
      }
    }
    if (estado === 'PAGO PARCIAL') {
      if (!pagoParcial || Number(pagoParcial) <= 0) {
        errores.push('Indica el monto del pago parcial.');
      }
    }

    if (errores.length) {
      erroresBox.innerHTML = '<ul><li>' + errores.join('</li><li>') + '</li></ul>';
      erroresBox.style.display = 'block';
      return false;
    }
    erroresBox.style.display = 'none';
    return true;
  }

  function formatearMoneda(valor) {
    if (!Number.isFinite(valor)) {
      return currencyFormatter.format(0);
    }
    return currencyFormatter.format(valor);
  }

  function escaparHtml(texto) {
    const mapa = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
    return texto.replace(/[&<>"']/g, (char) => mapa[char]);
  }

  function parseLineaProducto(linea) {
    if (!linea) return null;
    const priceRegex = /([\$qQ]?\s*\d+(?:[.,]\d+)?)(?:\s*(?:c\/u|cada\s+uno|unidad|u))?$/i;
    const match = priceRegex.exec(linea);
    if (!match) return null;
    const precioRaw = match[1];
    const antesDelPrecio = linea.slice(0, match.index).trim();
    const partes = antesDelPrecio.split(/\s+/);
    if (!partes.length) return null;
    const cantidadToken = partes.shift();
    if (!/^\d+$/.test(cantidadToken)) return null;
    let descripcion = partes.join(' ').trim();
    descripcion = descripcion.replace(/\s+(?:a|x|por|precio|cada|c\/u)\s*$/i, '').trim();
    if (!descripcion) return null;
    const precioNormalizado = precioRaw.replace(/[Qq$]/g, '').replace(/\s+/g, '').replace(',', '.');
    const precio = parseFloat(precioNormalizado);
    if (!Number.isFinite(precio)) return null;
    const cantidad = parseInt(cantidadToken, 10);
    return {
      qty: cantidad,
      description: descripcion,
      price: precio,
      total: cantidad * precio
    };
  }

  function actualizarPreview() {
    const texto = (productosTextarea.value || '').trim();
    const lineas = texto ? texto.split('\n').map(linea => linea.trim()).filter(Boolean) : [];
    let total = 0;
    const fragmentos = [];
    const erroresLocales = [];

    lineas.forEach((linea, indice) => {
      const data = parseLineaProducto(linea);
      if (!data) {
        erroresLocales.push(`Línea ${indice + 1}: usa "3 pelota gloria a 65".`);
        return;
      }
      total += data.total;
      fragmentos.push(`
        <div class="preview-item">
          <div class="preview-desc"><span class="preview-qty">${data.qty}×</span> ${escaparHtml(data.description)}</div>
          <div class="preview-prices">
            <div>${formatearMoneda(data.price)} c/u</div>
            <div class="preview-line-total">${formatearMoneda(data.total)}</div>
          </div>
        </div>
      `);
    });

    if (!fragmentos.length) {
      previewList.innerHTML = '<p class="preview-empty-text">Agrega productos con el formato "3 pelota gloria a 65" para ver el desglose.</p>';
    } else {
      previewList.innerHTML = fragmentos.join('');
    }

    previewTotal.textContent = `Total: ${formatearMoneda(total)}`;

    if (erroresLocales.length) {
      previewErrors.innerHTML = erroresLocales.join('<br>');
      previewErrors.classList.remove('hidden');
    } else {
      previewErrors.innerHTML = '';
      previewErrors.classList.add('hidden');
    }
  }

  async function iniciarDescarga(evt, tipo){
    evt.preventDefault();
    document.getElementById('plantilla').value = tipo;
    if (!validarFormulario()) {
      return;
    }
    await descargarArchivosSecuenciales();
  }

  async function descargarArchivosSecuenciales(){
    toggleBotones(true);
    try {
      await solicitarArchivo('pdf');
      await solicitarArchivo('png');
    } catch (error) {
      mostrarErrorServidor(error.message || 'Ocurrió un error al generar los archivos.');
    } finally {
      toggleBotones(false);
    }
  }

  function toggleBotones(desactivar){
    document.querySelectorAll('.btn.local1, .btn.local2').forEach(btn => {
      btn.disabled = desactivar;
      btn.textContent = desactivar ? 'Generando…' : (btn.classList.contains('local1') ? 'Local 1' : 'Local 2');
    });
  }

  async function solicitarArchivo(formato){
    const formData = new FormData(form);
    formData.set('formato', formato);
    const respuesta = await fetch(form.action, {
      method: 'POST',
      body: formData
    });

    if (!respuesta.ok) {
      const texto = await respuesta.text();
      throw new Error((texto || 'Error al generar el archivo').replace(/^❌\s*/, ''));
    }

    const blob = await respuesta.blob();
    const filename = obtenerNombreArchivo(respuesta.headers.get('Content-Disposition'), formato);
    const url = URL.createObjectURL(blob);
    const enlace = document.createElement('a');
    enlace.href = url;
    enlace.download = filename;
    document.body.appendChild(enlace);
    enlace.click();
    enlace.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }

  function obtenerNombreArchivo(disposicion, formato){
    if (disposicion){
      const match = /filename="?([^";]+)"?/i.exec(disposicion);
      if (match && match[1]) {
        return match[1];
      }
    }
    return formato === 'png' ? 'factura.png' : 'factura.pdf';
  }

  function mostrarErrorServidor(mensaje){
    erroresBox.innerHTML = '<ul><li>' + mensaje + '</li></ul>';
    erroresBox.style.display = 'block';
  }
</script>

</body>
</html>
